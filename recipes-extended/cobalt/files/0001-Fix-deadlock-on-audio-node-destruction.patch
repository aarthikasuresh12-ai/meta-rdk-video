Date: Thu, 26 Aug 2021 15:16:45 +0000
From: b653b733f1c9d2b10e497ccc302b6babb0bf5053 Mon Sep 17 00:00:00 2001
Subject: [PATCH] Fix deadlock on audio node destruction
Source: COMCAST
License: GPLV2
Upstream-Status: N/A
Signed-off-by: Eugene Mutavchi <Ievgen_Mutavchi@comcast.com>

---
 src/cobalt/audio/audio_destination_node.cc | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/cobalt/audio/audio_destination_node.cc b/src/cobalt/audio/audio_destination_node.cc
index 6f82ba8850..98a09e214e 100644
--- a/src/cobalt/audio/audio_destination_node.cc
+++ b/src/cobalt/audio/audio_destination_node.cc
@@ -67,6 +67,8 @@ void AudioDestinationNode::OnInputNodeConnected() {
 
 void AudioDestinationNode::FillAudioBus(bool all_consumed, AudioBus* audio_bus,
                                         bool* silence) {
+  if (audio_device_to_delete_) return;
+
   // This is called on Audio thread.
   AudioLock::AutoLock lock(audio_lock());
 
-- 
2.25.1

