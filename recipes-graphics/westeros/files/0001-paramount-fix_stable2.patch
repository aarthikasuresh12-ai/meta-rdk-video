From 3fcfc972620f7b847381dea9914fd6b9b89c7809 Mon Sep 17 00:00:00 2001
From: arajan800 <Anjali_Rajan@comcast.com>
Date: Mon, 14 Feb 2022 15:30:33 +0000
Subject: [PATCH] paramount-fix_stable2

Source: COMCAST
License: Apache-2.0
Upstream-Status: Pending
Signed-off-by: arajan800 <Anjali_Rajan@comcast.com>
---
 westeros-sink/brcm/westeros-sink-soc.c |  3 +++
 westeros-sink/westeros-sink.c          | 16 ++++------------
 2 files changed, 7 insertions(+), 12 deletions(-)

diff --git a/westeros-sink/brcm/westeros-sink-soc.c b/westeros-sink/brcm/westeros-sink-soc.c
index 9e264037..cd805ccb 100644
--- a/westeros-sink/brcm/westeros-sink-soc.c
+++ b/westeros-sink/brcm/westeros-sink-soc.c
@@ -1923,6 +1923,8 @@ static void freeCaptureSurfaces( GstWesterosSink *sink )
          sink->soc.captureSurface[i]= NULL;
       }
    }
+   sink->soc.captureWidth= -1;
+   sink->soc.captureHeight= -1;
 }

 static gboolean queryPeerHandles(GstWesterosSink *sink)
@@ -4443,6 +4445,7 @@ static void sinkReleaseVideo( GstWesterosSink *sink )
       sink->soc.dataProbeCodecData= 0;
    }
    #endif
+   freeCaptureSurfaces(sink);
    UNLOCK( sink );
    GST_DEBUG("sinkReleaseVideo: exit");
 }
diff --git a/westeros-sink/westeros-sink.c b/westeros-sink/westeros-sink.c
index 72bde533..1ca86c99 100644
--- a/westeros-sink/westeros-sink.c
+++ b/westeros-sink/westeros-sink.c
@@ -697,17 +697,13 @@ static gboolean gst_westeros_sink_backend_playing_to_paused( GstWesterosSink *si
 static gboolean gst_westeros_sink_backend_paused_to_ready( GstWesterosSink *sink, gboolean *passToDefault )
 {
    gboolean result;
-   if ( sink->rm && (sink->resAssignedId < 0) )
-   {
-      result= TRUE;
-   }
    #ifdef ENABLE_SW_DECODE
-   else if ( sink->rm && (sink->resCurrCaps.capabilities & EssRMgrVidCap_software) )
+   if ( sink->rm && (sink->resCurrCaps.capabilities & EssRMgrVidCap_software) )
    {
       result= wstsw_paused_to_ready( sink, passToDefault );
    }
-   #endif
    else
+   #endif
    {
       result= gst_westeros_sink_soc_paused_to_ready( sink, passToDefault );
    }
@@ -721,17 +717,13 @@ static gboolean gst_westeros_sink_backend_paused_to_ready( GstWesterosSink *sink
 static gboolean gst_westeros_sink_backend_ready_to_null( GstWesterosSink *sink, gboolean *passToDefault )
 {
    gboolean result;
-   if ( sink->rm && (sink->resAssignedId < 0) )
-   {
-      result= TRUE;
-   }
    #ifdef ENABLE_SW_DECODE
-   else if ( sink->rm && (sink->resCurrCaps.capabilities & EssRMgrVidCap_software) )
+   if ( sink->rm && (sink->resCurrCaps.capabilities & EssRMgrVidCap_software) )
    {
       result= wstsw_ready_to_null( sink, passToDefault );
    }
-   #endif
    else
+   #endif
    {
       result= gst_westeros_sink_soc_ready_to_null( sink, passToDefault );
    }
--
2.17.1
      